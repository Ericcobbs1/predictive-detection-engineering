id: pde-spl-0402
name: Password Spray Drift (Low-and-Slow) via Authentication Failure Baseline Deviation
detection_type: predictive
predictive_readiness: predictive_ready
severity: high

version: 0.1.0
status: experimental

description: >
  Predictive detection for low-and-slow password spray activity by identifying sustained drift in
  authentication failures across multiple user accounts from a single source, relative to historical baselines.
  Designed to catch distributed sprays that avoid static thresholds and lockouts.

log_source:
  platform: splunk
  product: authentication
  category: logon

data_sources:
  - authentication_logs

tags:
  - predictive
  - p2
  - password_spray
  - brute_force
  - auth
  - baseline
  - trend
  - low_and_slow

references:
  - https://attack.mitre.org/techniques/T1110/

mappings:
  mitre_attack:
    tactics:
      - TA0006
    techniques:
      - T1110

  cyber_kill_chain:
    phases:
      - reconnaissance
      - exploitation

  nist:
    csf:
      functions:
        - Detect
      categories:
        - DE.CM
        - DE.AE
      subcategories:
        - DE.CM-7
        - DE.AE-2
    nist_800_53:
      families:
        - AU
        - SI
      controls:
        - AU-6
        - SI-4

  pci_dss:
    requirements:
      - "10.2"
      - "10.6"

features:
  - name: auth_failures_per_src
    description: Count of authentication failures per source per bucket.
    entity: src_ip
  - name: unique_users_targeted
    description: Distinct user accounts targeted per source per bucket.
    entity: src_ip
  - name: failure_drift_ratio
    description: Ratio of current failures per source to baseline average.
    entity: src_ip
  - name: sustained_failure_growth
    description: Sustained positive growth in failures across N buckets for a source.
    entity: src_ip

prediction:
  target: password_spray_drift_low_and_slow
  method: baseline_deviation_and_trend
  horizon: early

alert_condition: >
  failure_drift_ratio >= 2.5 AND sustained_positive_trend(auth_failures_per_src, 3) AND unique_users_targeted >= 10

query:
  language: spl
  text: |
    /* PDE-SPL-0402: Password Spray Drift (Low-and-Slow) */
    /* Baseline: 30d, Observation: 72h, Bucket: 15m */
    /* Tunables: drift_ratio=2.5, sustained_buckets=3, min_users=10 */

    | noop
    | append [
        search earliest=-30d@d
        | bucket _time span=15m
        | stats count as failures dc(user) as baseline_unique_users by src_ip _time
        | stats avg(failures) as baseline_fail_avg
                stdev(failures) as baseline_fail_std
                avg(baseline_unique_users) as baseline_users_avg
                by src_ip
      ]
    | append [
        search earliest=-72h@h
        | bucket _time span=15m
        | stats count as failures dc(user) as unique_users_targeted by src_ip _time
        | sort 0 src_ip _time
        | streamstats current=f window=2 last(failures) as prev_failures by src_ip
        | eval growth_flag=if(failures>prev_failures,1,0)
        | streamstats window=3 sum(growth_flag) as growth_hits by src_ip
      ]
    | stats latest(failures) as failures
            latest(unique_users_targeted) as unique_users_targeted
            latest(growth_hits) as growth_hits
            latest(baseline_fail_avg) as baseline_fail_avg
            latest(baseline_fail_std) as baseline_fail_std
            latest(baseline_users_avg) as baseline_users_avg
            by src_ip
    | eval failure_drift_ratio=if(baseline_fail_avg>0, failures / baseline_fail_avg, null())
    | eval sustained_growth=if(growth_hits>=3, 1, 0)
    | where failure_drift_ratio>=2.5 AND sustained_growth=1 AND unique_users_targeted>=10
    | eval signal_name="Password Spray Drift (Low-and-Slow)"
    | table src_ip signal_name failures unique_users_targeted baseline_fail_avg failure_drift_ratio growth_hits baseline_users_avg

false_positives:
  - Misconfigured applications repeatedly authenticating with outdated credentials.
  - Password expiry events causing bursts of failed logons.
  - Security testing from approved internal ranges.
  - SSO/IdP retries or gateway misconfiguration generating repeated failures.

triage:
  steps:
    - Determine whether src_ip is internal, external, NAT, VPN, proxy, or known gateway.
    - Review targeted usernames for patterns (common names, service accounts, admin accounts).
    - Check for any successful logons from the same src_ip after failures.
    - Correlate with geo, ASN, device, user-agent, or IdP telemetry if available.
    - If internal, validate whether the source is an approved scanner or scripted job.

tuning:
  knobs:
    - Lower min_users to 5–8 for high-risk identity environments, raise to 15–25 for noisy tenants.
    - Increase drift_ratio to 3.0+ if baseline variance is high.
    - Change bucket span (5m–30m) depending on auth volume and expected spray rate.
    - Exclude known NAT/SSO gateway ranges, or split detections by internal vs external sources.
    - Filter to interactive logons only if service account noise is high.
